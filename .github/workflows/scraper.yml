name: Daily Scraper

on:
  schedule:
    # Run at 07:30 AM and 07:30 PM Thailand Time (UTC+7)
    # Cron uses UTC. 07:30 UTC+7 = 00:30 UTC
    # 19:30 UTC+7 = 12:30 UTC
    - cron: '30 0,12 * * *'
  workflow_dispatch:
    inputs:
      scraper_type:
        description: 'Scraper to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - transfer
        - ai
        - team_info

jobs:
  scrape_and_notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps

    - name: Create credentials.json
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json

    - name: Create .env file
      env:
        PM_USERNAME: ${{ secrets.PM_USERNAME }}
        PM_PASSWORD: ${{ secrets.PM_PASSWORD }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        CI: "true"
      run: |
        echo "PM_USERNAME=$PM_USERNAME" >> .env
        echo "PM_PASSWORD=$PM_PASSWORD" >> .env
        echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> .env
        echo "TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID" >> .env
        echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> .env
        echo "CI=true" >> .env

    - name: Run Team Info Scraper
      if: ${{ github.event_name == 'schedule' || github.event.inputs.scraper_type == 'team_info' || github.event.inputs.scraper_type == 'all' }}
      run: python main_team_info.py

    - name: Run All Transfer Scraper
      if: ${{ github.event_name == 'schedule' || github.event.inputs.scraper_type == 'transfer' || github.event.inputs.scraper_type == 'all' }}
      run: python main_all_transfer.py

    - name: Run AI Recommendation
      if: ${{ github.event_name == 'schedule' || github.event.inputs.scraper_type == 'transfer' || github.event.inputs.scraper_type == 'ai' || github.event.inputs.scraper_type == 'all' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python ai_recommendation.py
      
    - name: Keepalive Workflow
      uses: gautamkrishnar/keepalive-workflow@v1
